@using riwitalentfrontend.Services;
@using riwitalentfrontend.Components
@using riwitalentfrontend.Models;
@inject ICoderService coderService;
@inject IModalService model;
@inject HttpClient Http
@inject IAlertService alertService;
@namespace riwitalentfrontend.Components
<MudChipSet Class="z-100" T="string" AllClosable OnClose="RemoveCoderFromGroup">
    @foreach (var selectedCoder in SelectedCoders)
    {
        <MudChip Text="@($"{selectedCoder.FirstName} {selectedCoder.FirstLastName}")">
            <AvatarContent>
                <MudAvatar>
                    <MudImage Src="@selectedCoder.Photo"></MudImage>
                </MudAvatar>
            </AvatarContent>
        </MudChip>
    }
</MudChipSet>

<MudStack Justify="Justify.FlexEnd" Class="gap-2 ma-2 pa-2" Style="height: 100vh;" @bind-Open="_open">
    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudText Justify="Justify.FlexStart" Color="Color.Error">@_errorMessage</MudText>
    }
    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="AddCoderHandler">Agregar Coders</MudButton>
</MudStack>

@code {
    [Parameter]
    public List<Coder> SelectedCoders { get; set; } = new List<Coder>();
    [Parameter]
    public EventCallback AddCodersToGroupAsync { get; set; }
    [Parameter]
    public EventCallback<Coder> OnCoderAdded { get; set; }
    
    private string? _errorMessage;
    private bool _open = true; // Inicialmente abierto

    public async Task AddCoderHandler()
    {
        _errorMessage = null; // Resetea el mensaje de error
        if (AddCodersToGroupAsync.HasDelegate && SelectedCoders.Count > 0)
        {
            await AddCodersToGroupAsync.InvokeAsync();
            _open = false; // Cerrar el MudStack después de agregar con éxito
            SelectedCoders.Clear();
            Console.WriteLine("_open: " + _open);
            await alertService.AddCodersToGroup();
        }
        else
        {
            _errorMessage = "No hay coders seleccionados.";
            _open = true; // Asegura que el MudStack esté visible para mostrar el mensaje
        }
    }

    public async Task AddCoderToGroup(Coder coder)
    {
        if (!SelectedCoders.Contains(coder))
        {
            SelectedCoders.Add(coder);
            await OnCoderAdded.InvokeAsync(coder);
            _errorMessage = null; // Limpiar el mensaje al añadir un coder
            _open = true; // Mantener el MudStack abierto
        }
    }

    public void RemoveCoderFromGroup(MudChip<string> chip)
    {
        var coderToRemove = SelectedCoders.FirstOrDefault(c => $"{c.FirstName} {c.FirstLastName}" == chip.Text);
        if (coderToRemove != null)
        {
            SelectedCoders.Remove(coderToRemove);
        }
        
        if (SelectedCoders.Count == 0)
        {
            _errorMessage = "No hay coders seleccionados.";
            _open = true; // Mostrar el MudStack para el mensaje
        }
    }
}
