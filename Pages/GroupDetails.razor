@page "/GroupDetails/{groupId}"
@using riwitalentfrontend.Components.GroupCoder
@layout MainLayout
@inject IGroupService GroupService
@inject SweetAlertService Swal;
@inject AlertService AlertService;
@inject NavigationManager NavigationManager

@attribute [Authorize]


<PageTitle>RiwiTalent: Detalles del Grupo</PageTitle>

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <!-- Muestra alerta si se produce un error -->
    <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
}
<AuthorizeView>
    <Authorized>
        @if (_loading)
        {
            <MudProgressLinear />
        }
        else
        {
            <MudContainer Class="ma-3 d-flex flex-column flex-grow-1 justify-center align-content-start">
                <MudContainer Class="d-flex justify-space-between flex-grow-1 gap-4 py-3 px-0">
                    <!-- Botón Regresar -->
                    <MudTooltip Text="Regresar">
                        <MudIconButton
                            Href="/groups"
                            Variant="Variant.Outlined"
                            Icon="@Icons.Material.Rounded.ArrowBackIos"
                            Color="Color.Primary"
                            Size="Size.Small"
                            Class="border-solid border-2 mud-border-primary pa-2">
                        </MudIconButton>
                    </MudTooltip>
                    
                    <!-- Botón Editar y Agregar -->
                    <MudButton
                        Variant="Variant.Filled"
                        Color="@((isEditing ? Color.Success : Color.Primary))"
                        StartIcon="@(isEditing ? Icons.Material.Rounded.Save : Icons.Material.Rounded.Edit)"
                        OnClick="@ToggleEditState">
                        @(isEditing ? "Guardar Grupo" : "Editar Grupo")
                    </MudButton>
                </MudContainer>
                <!-- Detail groups -->
                <MudGrid Justify="Justify.SpaceBetween" Spacing="3">

                    <!-- Card con Avatar y Nombre del Grupo -->
                    <MudItem xs="12" sm="4" md="4">
                        <MudCard Class="d-flex flex-column align-center justify-center mud-width-full pa-4">
                            @if(!string.IsNullOrEmpty(_group.Photo))
                            {
                                <MudAvatar  Style="height:150px; width:150px; font-size:2rem;" Color="Color.Primary">
                                    <MudImage Src="@_group.Photo"></MudImage>
                                </MudAvatar>
                            }
                            else
                            {
                                <MudAvatar Icon="@Icons.Material.Filled.Person" Style="height:150px; width:150px; font-size:2rem;" Color="Color.Primary"></MudAvatar>
                            }
                            <MudText Typo="Typo.h6" Color="Color.Primary">@_group.Name</MudText>
                            <MudItem Class="d-flex mt-3">
                                <MudChip T="string" Color="@GetChipColor(_group.Status)" Value="@_group.Status"></MudChip>

                                @if(isEditing == true)
                                {
                                    <MudFileUpload T="IBrowserFile" FilesChanged="UploadPhotoGroup" @bind-Value="_files" MaximumFileCount="2000000">
                                        <ActivatorContent>
                                            <MudFab Color="Color.Success"
                                                    Style="width: 40px; height: 32px"
                                                    StartIcon="@Icons.Material.Filled.AttachFile" />
                                        </ActivatorContent>
                                    </MudFileUpload>
                                }
                            </MudItem>
                        </MudCard>
                    </MudItem>

                    <!-- Card con Información del Grupo y Credenciales -->
                    <MudItem xs="12" sm="8" md="8">
                        <MudCard Class="d-flex pa-4">
                            <MudCardContent Class="FullWidth">
                                <MudForm Spacing="2">

                                    <!-- Título: Información del Grupo -->
                                    <MudGrid>
                                        <MudItem xs="12">
                                            <MudText Align="Align.Start" Typo="Typo.h5"><b>Información del grupo</b></MudText>
                                        </MudItem>

                                        <!-- Nombre del Grupo -->
                                        <MudItem xs="12" sm="6">
                                            <MudText Typo="Typo.subtitle2"><b>Nombre</b></MudText>
                                            <MudTextField T="string"
                                                          @bind-Value="@_group.Name"
                                                          Placeholder="Ingresa el nombre del grupo"
                                                          Variant="Variant.Outlined"
                                                          FullWidth="true"
                                                          Margin="Margin.Dense"
                                                          AdornmentIcon="@Icons.Material.Rounded.PeopleOutline"
                                                          Adornment="Adornment.Start"
                                                          AdornmentColor="Color.Primary"
                                                          ReadOnly="!isEditing">
                                            </MudTextField>
                                        </MudItem>

                                        <!-- Descripción del Grupo -->
                                        <MudItem xs="12">
                                            <MudText Typo="Typo.subtitle2"><b>Descripción</b></MudText>
                                            <MudTextField T="string"
                                                          @bind-Value="@_group.Description"
                                                          Placeholder="Escribe una breve descripción del grupo"
                                                          Variant="Variant.Outlined"
                                                          FullWidth="true"
                                                          Lines="3"
                                                          Margin="Margin.Dense"
                                                          ReadOnly="!isEditing">
                                            </MudTextField>
                                        </MudItem>

                                        <!-- Título: Credenciales -->
                                        <MudItem xs="12">
                                            <MudText Typo="Typo.h5"><b>Credenciales</b></MudText>
                                        </MudItem>

                                        <!-- Link Público -->
                                        <MudItem xs="12" sm="12" md="6">
                                            <MudText Typo="Typo.subtitle2"><b>Enlace público</b></MudText>
                                            <MudItem>
                                                <MudTextField T="string"
                                                              @bind-Value="_group.ExternalKeys[0].Url"
                                                              Placeholder="Ingresa el enlace público del grupo"
                                                              Variant="Variant.Outlined"
                                                              Margin="Margin.Dense"
                                                              FullWidth="true"
                                                              AdornmentIcon="@Icons.Material.Rounded.InsertLink"
                                                              Adornment="Adornment.Start"
                                                              AdornmentColor="Color.Primary"
                                                              ReadOnly="!isEditing">
                                                </MudTextField>
                                            </MudItem>
                                        </MudItem>

                                            <!-- Pin de Acceso -->
                                            <MudItem xs="12" sm="12" md="6">
                                                <MudText Typo="Typo.subtitle2"><b>Pin de acceso</b></MudText>
                                                <MudItem Class="d-flex flex-row align-center gap-2">
                                                    <MudTextField T="string"
                                                                  @bind-Value="_group.ExternalKeys[0].Key"
                                                                  Label="Contraseña"
                                                                  Margin="Margin.Dense"
                                                                  Variant="Variant.Outlined" 
                                                                  InputType="@_passwordInput" 
                                                                  IconSize="Size.Small" 
                                                                  Adornment="Adornment.End" 
                                                                  AdornmentIcon="@_passwordInputIcon" 
                                                                  OnAdornmentClick="ButtonTestclick" 
                                                                  AdornmentAriaLabel="Ver Contraseña"
                                                                  ReadOnly="true"/>
                                                    <RegenerateTokenComponent groupId="@groupId" OnTokenRegenerated="@OnTokenRegenerated" />
                                                </MudItem>
                                            </MudItem>
                                    </MudGrid>
                                </MudForm>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                </MudGrid>
            </MudContainer>

            <!-- Total coders en el grupo -->
            <ListCodersGroupComponent GroupId="@groupId"/>
        }
    </Authorized>
</AuthorizeView>

@code {
    [Parameter] public string? groupId { get; set; }

    private IBrowserFile _files;
    private Group _group;
    private string _searchString;
    private bool _loading = true;
    private string _errorMessage;
    private string _rowsPerPageString = "Filas por página:";
    private string _infoFormat = "{first_item}-{last_item} de {all_items}";
    private bool isEditing = false;

    private async Task UploadPhotoGroup(IBrowserFile file)
    {

        if(!string.IsNullOrEmpty(groupId))
        {
            if(file != null)
            {
                var stream = file.OpenReadStream(2 * 1024 * 1024);

                await GroupService.UploadPhoto(groupId, stream, file.Name);
                await LoadGroupDetailsAsync();
            }
            else
            {
                Console.WriteLine("No file selected");
            }
        }

    }

    protected override async Task OnInitializedAsync()
    {
        await LoadGroupDetailsAsync();
    }

    private void ToggleEditState()
    {
        if (isEditing)
        {
            UpdateGroup();
        }
        else
        {
            EnableEditMode();
        }

        isEditing = !isEditing;
    }

    private void EnableEditMode()
    {
        Console.WriteLine("Modo de edición habilitado");
    }

    private async Task UpdateGroup()
    {
        // Mostrar alerta de confirmación
        var result = await Swal.FireAsync(new SweetAlertOptions
        {
            Icon = SweetAlertIcon.Success,
            Title = "¿Estás seguro/a de que deseas guardar los cambios de este registro?",
            Text = "Esta acción actualizará la información y no podrá recuperarse.",
            ShowCancelButton = true,
            ConfirmButtonColor = "#5ACCA4",
            ConfirmButtonText = "Sí, Confirmar",
            CancelButtonColor = "#fff",
            CancelButtonText = "No, Cancelar"
        });


        // Si el usuario confirma, proceder con la actualización
        if (result.IsConfirmed)
        {
            // Llamada al servicio para actualizar el _group
            var response = await GroupService.Update(_group);

            if (response)
            {
                // Cambiar de vuelta al modo de visualización
                isEditing = false;

                // Mostrar mensaje de éxito
                await Swal.FireAsync(new SweetAlertOptions
                {
                    Title = "Los datos se han guardado exitosamente",
                    Icon = SweetAlertIcon.Success,
                    ShowConfirmButton = false,
                    Timer = 1500
                });


                NavigationManager.NavigateTo($"/GroupDetails/{groupId}");
            }
            else
            {
                Console.WriteLine("Error al actualizar el grupo");
            }
        }
        else
        {

            Console.WriteLine("Actualización cancelada");
        }
    }

    private async Task LoadGroupDetailsAsync()
    {
        try
        {
            _group = await GroupService.GetGroupByIdAsync(groupId);
            if (_group != null)
            {
                Console.WriteLine($"Grupo obtenido: {_group.Name}, Estado: {_group.Status}, {_group.Photo}");
            }
            else
            {
                _errorMessage = "No se encontró el grupo.";
            }
        }
        catch (HttpRequestException ex)
        {
            _errorMessage = "Error de red al obtener los detalles del grupo.";
            Console.WriteLine($"Error de red: {ex.Message}");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Hubo un error al obtener los detalles del grupo: {ex.Message}";
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }


    // Filtro de búsqueda
    private Func<Models.Group, bool> QuickFilter => group =>
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;

        return MatchesSearchCriteria(group);
    };

    private bool MatchesSearchCriteria(Models.Group group)
    {
        return (group.Name?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ?? false) ||
               (group.Status?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ?? false) ||
               (group.Created_At.ToString("dd-MM-yyyy").Contains(_searchString, StringComparison.OrdinalIgnoreCase));
    }


    private Color GetChipColor(string? status)
    {
        return status switch
        {
            "Activo" => Color.Success,
            "Inactivo" => Color.Error,
            _ => Color.Default,
        };
    }

    public GroupCoders GetGroupCoders(string? name, string? status)
    {
        bool statusBool;

        if (status == "Activo")
        {
            statusBool = true;
        }
        else
        {
            statusBool = false;
        }

        GroupCoders groupCoders = new GroupCoders()
        {
            Name = name,
            IsActive = statusBool
        };

        return groupCoders;
    }

    bool _isShow;
    InputType _passwordInput = InputType.Password;
    string _passwordInputIcon = Icons.Material.Filled.VisibilityOff;

    void ButtonTestclick()
    {
        if (_isShow)
        {
            _isShow = false;
            _passwordInputIcon = Icons.Material.Filled.VisibilityOff;
            _passwordInput = InputType.Password;
        }
        else
        {
            _isShow = true;
            _passwordInputIcon = Icons.Material.Filled.Visibility;
            _passwordInput = InputType.Text;
        }
    }

    private async Task OnTokenRegenerated(bool isRegenerated)
    {
        if (isRegenerated)
        {
            await LoadGroupDetailsAsync(); // Cargar nuevamente los detalles del grupo
        }
        else
        {
            // Aquí podrías mostrar un mensaje de error al usuario
            Console.WriteLine("No se pudo regenerar el token.");
        }
    }
}
}
